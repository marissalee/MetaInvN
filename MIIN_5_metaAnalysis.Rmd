---
title: "MIIN Part 5: Meta-analysis"
author: "Marissa Lee"
date: "January 21, 2015"
output: pdf_document
---

**Filename: MIIN_5_metaAnalysis.Rmd**  
**This markdown file does the following tasks:**  

1. Calculate global effect sizes and plot

2. Test for inclusion of categorical moderators.  Where a categorical moderator is warrented, make a forest plot and conduct post-hoc Tukeys: A) Study type, B) N fixer status, C) Ecosystem type, D) Quality  

3. Test for correlation between CWM traits and effect size values. Record the outcomes in a table. In cases where the slope coefficient significantly differs from 0, plot it.

```{r libraries, echo=TRUE}
knitr::opts_chunk$set(cache=TRUE)

library(ggplot2)
library(gridExtra)
library(plyr)
library(reshape2)
library(metafor)

source('CODE/mytheme.R')
source('CODE/metaAnalysis/fxn_PrepForestPlot.R')
#source('CODE/metaAnalysis/fxn_FactorForests.R') #this is fxn calculated whether each level differed from 0.  no longer needed now that I am calculating and reporting posthoc t-tests
source('CODE/metaAnalysis/fxn_FitPlot.R')

figuresPath<-file.path(getwd()[1], "FIGURES_TABLES", "metaAnalysis") #where to put the saved plots
fig.height<-2.5 #inches
fig.width<- 2.5 #inches
fig.res<-300

dat<-read.table("DATA/DATA_SYNTHESIZED/calcES/metaDataset.txt", header=TRUE, sep="\t")
source('CODE/metaAnalysis/script_orderLevels.R')

#dat structure
summ<-ddply(dat, ~measCat+traitCat, summarize,
                 uniqueObs = length(unique(obsID)))
#summ
```

_________________________________________________________________
# 1. Calculate global effect sizes and plot
1A. Fit a nested random effects model. Model syntax is res <- rma.mv(yi, vi, random=list(~1 | paperID, ~1 | obsID), data=dat1, subset=measCat==MEASCAT[i], slab=paste(paperID,obsID, sep=","))
```{r calcGlob, echo=TRUE, warning=FALSE, message=FALSE}
dat1<-dat[!is.na(dat$yi),]
dat.meas<-ddply(dat1, ~obsID+measCat, summarize,
                yi = unique(yi),
                vi = unique(vi),
                paperID = unique(paperID))
res.list<-list()
i<-0
for(i in 1:length(MEASCAT)){
  res <- rma.mv(yi, vi, 
                random=list(~1 | paperID, ~1 | obsID), 
                data=dat.meas, subset=measCat==MEASCAT[i], 
                slab=as.character(obsID), 
                method='ML')
  res.list[[i]]<-res
  print(paste(i, 'of', length(MEASCAT)))
}
names(res.list)<-MEASCAT
resultdf<-PrepForestPlot(res.list) #save estimates, pvalues, and prep dataframe for plotting
resultdf
newfilename<-'globalMeans.txt'
write.table(resultdf, file=paste(figuresPath,'globalForest',newfilename, sep='/'), sep='\t')
#intraPaperCorr #if this # is high, it means that the underlying true effects within paperIDs are estimated to correlate quite strongly
#Heterogen #the sum of the two variance components can be interpreted as the total amount of heterogeneity in the true effects

# #View profile likelihood plots
# par(mfrow=c(2,1))
# i<-0
# for(i in 1:length(res.list)){
#   res<-res.list[[i]]
#   profile(res, sigma2=1)
#   mtext(labels[i])
#   profile(res, sigma2=2)
#   mtext(labels[i])
# }
#if both have 1 peak, we can be sure that both variance components are identifiable
```
1B. Fit just the Liao 2008 subset.
```{r calcGlob_Liao, echo=TRUE, warning=FALSE, message=FALSE}
dat.Liao<-subset(dat1, source2 == 'Liao 2008')
dat.Liao.meas<-ddply(dat.Liao, ~obsID+measCat, summarize,
                yi = unique(yi),
                vi = unique(vi),
                paperID = unique(paperID))
res.Liao.list<-list()
i<-0
for(i in 1:length(MEASCAT)){
  res <- rma.mv(yi, vi, 
                random=list(~1 | paperID, ~1 | obsID), 
                data=dat.Liao.meas, subset=measCat==MEASCAT[i], 
                slab=as.character(obsID),
                method='ML')
  res.Liao.list[[i]]<-res
  print(paste(i, 'of', length(MEASCAT)))
}
names(res.Liao.list)<-MEASCAT
resultdf.Liao<-PrepForestPlot(res.Liao.list) #save estimates and prep dataframe for plotting
resultdf.Liao
newfilename<-'globalMeans_Liao.txt'
write.table(resultdf.Liao, file=paste(figuresPath,'globalForest',newfilename, sep='/'), sep='\t')
```
1C. Make global forest plot comparing Liao 2008 and the full dataset
```{r plotGlob, echo=TRUE, warning=FALSE, message=FALSE}
#update effect size table for plotting with ggplot
resultdf$y<-NA
resultdf.Liao$y<-NA
CATl<-rev(levels(resultdf$measCAT))
i<-0
for(i in 1:length(CATl)){
  resultdf[resultdf$measCAT==CATl[i],'y']<-i-0.15  
  resultdf.Liao[resultdf.Liao$measCAT==CATl[i],'y']<-i+0.15
}
resultdf$source2<-'Full dataset'
resultdf.Liao$source2<-'Liao 2008'
resultdf.full<-rbind(resultdf, resultdf.Liao)
cols <- c("Liao 2008" = "gray","Full dataset" = "black")

#make ggplot plot
glob.sp<-ggplot(data=resultdf.full,aes(x=est,y=y, label=k, color=source2)) + 
  geom_point(size=3) +
  geom_errorbarh(aes(xmin=cil,xmax=ciu), height=0, show_guide=FALSE) +
  geom_vline(xintercept=0,linetype="dashed") + 
  mytheme + xlab('Std. Mean Diff. (Inv-Ref)') + ylab('') +
  scale_y_continuous(breaks=seq(1,length(MEASCAT)),labels=rev(labels), 
                     limits=c(0.5,9.5), expand=c(0,0)) + 
  geom_text(aes(x=ciu, y=y, hjust=-0.5, vjust=0.5),size=2.2,show_guide = FALSE) + 
  xlim(-0.6,1.5) +
  geom_text(aes(label=ifelse(alpha05==TRUE,"*", ""), hjust=-0.6, vjust=0.4), 
            size=5, show_guide=FALSE) +
  scale_color_manual(name='Source',values=cols, breaks=c('Liao 2008','Full dataset'))
glob.sp

#save global forest plot
newfilename<-"globalForest.png"
png(paste(figuresPath,'globalForest',newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*3, res=fig.res)
glob.sp
dev.off()
```

_________________________________________________________________
# 2. Test for inclusion of categorical moderators.
2A. Fit a random-effects model with 1 of the categorical variables as a fixed effect. Model syntax is res <- rma.mv(yi, vi, mods= ~factor(Xmod), random=list(~1 | paperID, ~1 | obsID), data=dat1, subset=measCat==MEASCAT[i], slab=paste(paperID,obsID, sep=",")) where Xmod is one of the following: (1) Quality, (2) Ecosystem type, (3) Study type, (4) Invasive legumes present/absent, (5) Reference legumes present/absent
```{r calcFact, echo=TRUE, warning=FALSE, message=FALSE}
dat.meas<-ddply(dat, ~obsID+measCat, summarize,
                yi = unique(yi),
                vi = unique(vi),
                paperID = unique(paperID),
                measQuality= unique(measQuality),
                ecosystCat= unique(ecosystCat),
                studyType= unique(studyType),
                Nfix= unique(Nfix))
dat.tmp<-dat.meas[dat.meas$measCat %in% MEASCAT,]
dat.tmp<-dat.tmp[!is.na(dat.tmp$yi),]

#look for singularities
temp<-ddply(dat.tmp, ~measCat+Nfix, summarize, n=length(paperID))
temp
which(temp$n==1)

#for the ecosystCat, remove the 'other' level from the model
dat.tmp<-dat.tmp[dat.tmp$ecosystCat != 'other',]
dat.tmp$ecosystCat<-droplevels(dat.tmp$ecosystCat)

### fit 3-level random-effects models with a categorical mod
res<-list()
res.quality<-list()
res.ecosyst<-list()
res.studytype<-list()
res.Nfix<-list()
i<-0
for(i in 1:length(MEASCAT)){
  subdat<-subset(dat.tmp, measCat==MEASCAT[i])
  
  #reduced model
  res[[i]]<- rma.mv(yi, vi, 
                    random=list(~1 | paperID, ~1 | obsID), 
                    data=subdat, slab=as.character(obsID),
                    method='ML')
  
  #full models
  res.quality[[i]]<- rma.mv(yi, vi, 
                            mods= ~factor(measQuality), 
                            random=list(~1 | paperID, ~1 | obsID), 
                            data=subdat, slab=as.character(obsID),
                            method='ML')
  res.ecosyst[[i]]<- rma.mv(yi, vi, 
                            mods= ~factor(ecosystCat), 
                            random=list(~1 | paperID, ~1 | obsID), 
                            data=subdat, slab=as.character(obsID),
                            method='ML')
  res.studytype[[i]]<- rma.mv(yi, vi, 
                              mods= ~factor(studyType), 
                              random=list(~1 | paperID, ~1 | obsID), 
                              data=subdat, slab=as.character(obsID),
                              method='ML')
  res.Nfix[[i]]<- rma.mv(yi, vi, 
                           mods= ~factor(Nfix), 
                           random=list(~1 | paperID, ~1 | obsID), 
                           data=subdat, slab=as.character(obsID),
                         method='ML')
  print(paste(i, 'of', length(MEASCAT)))
}
names(res)<-MEASCAT
names(res.quality)<-MEASCAT
names(res.ecosyst)<-MEASCAT
names(res.studytype)<-MEASCAT
names(res.Nfix)<-MEASCAT

#Test whether inclusion of any of these moderators are warrented
ANOVAParams<-function(fullMod, reducedMod){
  anova.comp<-anova(fullMod,reducedMod)
  anova.comp.df<-data.frame(p.f=anova.comp$p.f,
                            LRT=round(anova.comp$LRT, digits=3),
                            pval=round(anova.comp$pval, digits=3))
  return(anova.comp.df)
}
i<-0
tmp.list<-list()
for(i in 1:length(MEASCAT)){
  p.r<-anova(res.quality[[i]], res[[i]])$p.r #reduced model parameters
  qualityA<-ANOVAParams(fullMod=res.quality[[i]], reducedMod=res[[i]]) #full vs reduced model anova and extract params
  ecosystA<-ANOVAParams(fullMod=res.ecosyst[[i]], reducedMod=res[[i]])
  studytypeA<-ANOVAParams(fullMod=res.studytype[[i]], reducedMod=res[[i]])
  NfixA<-ANOVAParams(fullMod=res.Nfix[[i]], reducedMod=res[[i]])
  tmpdf<-rbind(qualityA, ecosystA, studytypeA, NfixA) #same anova params in a dataframe
  anovaLabels<-c('qualityA','ecosystA','studytypeA','NfixA') #name all the rows
  p.rCol<-rep(p.r, dim(tmpdf)[1]) #add a column to hold the reduced model information
  tmp.list[[i]]<-data.frame(anovaLabels, p.rCol, tmpdf)
}
names(tmp.list)<-MEASCAT
anovaMods<-ldply(tmp.list)
anovaMods
newfilename<-'anovaMods.txt'
write.table(anovaMods, file=paste(figuresPath,'modForests',newfilename, sep='/'), sep='\t')
```
2Bi. Study type
```{r studytype, echo=TRUE, warning=FALSE, message=FALSE}
currMeasFac<-anovaMods[anovaMods$anovaLabels=='studytypeA' & anovaMods$pval < 0.05,'.id']
currMeasFac

#Run post-hoc comparisions among Study type levels, pull out means and CI
i<-0
posthoc.list<-list()
pred.list<-list()
for(i in 1:length(currMeasFac)){
  #1. calc posthoc pvals
  posthocR<-anova(res.studytype[[currMeasFac[i]]], 
      L=rbind(c(1,-1,0,0), #fs vs ea
              c(1,0,-1,0), #fs vs er
              c(1,0,0,-1), #fs vs gh
              c(0,1,-1,0), #ea vs er
              c(0,1,0,-1), #ea vs gh
              c(0,0,1,-1)  #er vs gh
              ))
  levelcomp<-c('fs_ea','fs_er','fs_gh','ea_er','ea_gh','er_gh')
  posthoc.list[[i]]<-data.frame(levelcomp, pval=round(posthocR$pval, digits=4))
  #2. calc predicted values by level
  predR<-predict(res.studytype[[currMeasFac[i]]])
  tmp<-data.frame(obsID=predR$slab, pred=predR$pred, 
                  cilb=predR$ci.lb, ciub=predR$ci.ub, se=predR$se)
  ind.studyType<-ddply(dat.tmp, ~obsID, summarize, studyType1=unique(studyType))
  tmp1<-merge(tmp, ind.studyType)
  tmp2<-ddply(tmp1, ~studyType1, summarize,
        pred = unique(pred),
        cilb = unique(cilb),
        ciub = unique(ciub),
        se = unique(se),
        k = length(obsID))
  pred.list[[i]]<-tmp2
  }
names(posthoc.list)<-currMeasFac
posthocR<-ldply(posthoc.list)
posthocR

names(pred.list)<-currMeasFac
predR<-ldply(pred.list)
predR

#update effect size table for plotting
colnames(predR)[1]<-'MeasFac'
selectMeas<-unique(predR$MeasFac)
MeasFacl<-rev(levels(factor(MEASCAT[MEASCAT %in% selectMeas], levels=MEASCAT[MEASCAT %in% selectMeas])))
MeasNamesl<-rev(measTab[measTab$MEASCAT %in% selectMeas,'labels'])
colnames(predR)[2]<-'CAT'
CAT<-levels(dat$studyType)
predR$y<-NA
i<-0
for(i in 1:length(MeasFacl)){
  predR[predR$CAT==CAT[1] & predR$MeasFac==MeasFacl[i],'y']<-i+0.3
  predR[predR$CAT==CAT[2] & predR$MeasFac==MeasFacl[i],'y']<-i+0.1
  predR[predR$CAT==CAT[3] & predR$MeasFac==MeasFacl[i],'y']<-i-0.1
  predR[predR$CAT==CAT[4] & predR$MeasFac==MeasFacl[i],'y']<-i-0.3
}
predR

#assign post-hoc letters (order:field study, expt addition, expt removl, gh)
#subset(posthocR, .id=='biom')
phTno<-c('a','b','b','b') 
phTsom<-c('','','','')
predR$posthocL<-c(phTno,phTsom)

#assign pretty names and symbols
faclimits<-rev(c('Greenhouse study',
             'Removal expt',
             'Addition expt',
             'Observational study'))
facShapes<-c(16,17,15,18)
predR$annLabel<-paste(predR$posthocL, ' (',predR$k,')', sep='')

#ggplot
predR1<-predR #get rid of the CIs for a level with only 1 data point
predR1[predR1$MeasFac == 'som' & predR1$CAT == 'field expt addition',c('cilb','ciub')]<-NA
stud.sp<-ggplot(data=predR1,aes(x=pred,y=y, shape=CAT, label=annLabel)) + 
  geom_point(aes(shape=CAT),size=3) +
  geom_errorbarh(aes(xmin=cilb,xmax=ciub), height=0)+
  geom_vline(xintercept=0,linetype="dashed") + mytheme +
  xlab('Std. Mean Diff. (Inv-Ref)') + ylab('') +
  scale_y_continuous(breaks=c(1,2),labels=MeasNamesl) +
  scale_shape_manual(name="Factor",
                     labels=faclimits,
                     values=facShapes)+
  geom_text(aes(x=ciub, y=y, hjust=-0.3, vjust=0.5),size=2.2,show_guide = FALSE) +
  annotate("text", x=1, y=1.1, label=' (1)', size=2.2)+ #manually add the posthoc letters and k here
  scale_x_continuous(expand=c(0,0), limits=c(-1.5,5.3)) 
stud.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10)) 

newfilename<-"studytypeForest.png"
png(paste(figuresPath,'modForests',newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*1.5, res=fig.res)
stud.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10)) 
dev.off()
```
2Bii. Nfix status
```{r nfix, echo=TRUE, warning=FALSE, message=FALSE}
currMeasFac<-anovaMods[anovaMods$anovaLabels=='NfixA' & anovaMods$pval < 0.05,'.id']
currMeasFac

#levels(dat.tmp$Nfix) #check to make sure that this lines up with the way I organized the contrasts
#Run post-hoc comparisions among Nfix levels, pull out means and CI
i<-0
posthoc.list<-list()
pred.list<-list()
for(i in 1:length(currMeasFac)){
  #1. calc posthoc pvals
  posthocR<-anova(res.Nfix[[currMeasFac[i]]], 
      L=rbind(c(1,-1,0,0), #I-R- vs I-R+
              c(1,0,-1,0), #I-R- vs I+R-
              c(1,0,0,-1), #I-R- vs I+R+
              c(0,1,-1,0), #I-R+ vs I+R-
              c(0,1,0,-1), #I-R+ vs I+R+
              c(0,0,1,-1)  #I+R- vs I+R+
              ))
  levelcomp<-c('none_r','none_i','none_both','r_i','r_both','i_both')
  posthoc.list[[i]]<-data.frame(levelcomp, pval=round(posthocR$pval, digits=4))
  #2. calc predicted values by level
  predR<-predict(res.Nfix[[currMeasFac[i]]])
  tmp<-data.frame(obsID=predR$slab, pred=predR$pred, cilb=predR$ci.lb, ciub=predR$ci.ub, se=predR$se)
  ind.Fac<-ddply(dat.tmp, ~obsID, summarize, Level=unique(Nfix))
  tmp1<-merge(tmp, ind.Fac)
  tmp2<-ddply(tmp1, ~Level, summarize,
        pred = unique(pred),
        cilb = unique(cilb),
        ciub = unique(ciub),
        se = unique(se),
        k = length(obsID))
  pred.list[[i]]<-tmp2
  }
names(posthoc.list)<-currMeasFac
posthocR<-ldply(posthoc.list)
posthocR

names(pred.list)<-currMeasFac
predR<-ldply(pred.list)
predR

#update effect size table for plotting
colnames(predR)[1]<-'MeasFac'
selectMeas<-unique(predR$MeasFac)
MeasFacl<-rev(levels(factor(MEASCAT[MEASCAT %in% selectMeas], levels=MEASCAT[MEASCAT %in% selectMeas])))
MeasNamesl<-rev(measTab[measTab$MEASCAT %in% selectMeas,'labels'])
colnames(predR)[2]<-'CAT'
CAT<-levels(dat$Nfix)
predR$y<-NA
i<-0
for(i in 1:length(MeasFacl)){
  predR[predR$CAT==CAT[1] & predR$MeasFac==MeasFacl[i],'y']<-i+0.3
  predR[predR$CAT==CAT[2] & predR$MeasFac==MeasFacl[i],'y']<-i+0.1
  predR[predR$CAT==CAT[3] & predR$MeasFac==MeasFacl[i],'y']<-i-0.1
  predR[predR$CAT==CAT[4] & predR$MeasFac==MeasFacl[i],'y']<-i-0.3
}
predR

#assign post-hoc letters (order:field study, expt addition, expt removl, gh)
#subset(posthocR, .id=='litterbiom')
phTtoti<-c('b','a','b','b') 
phTsoiln<-c('a','a','b','a') #check this one
phTsoilcn<-c('a','b','a','a') 
predR$posthocL<-c(phTtoti,phTsoiln, phTsoilcn)

#assign pretty names and symbols
faclimits<-unique(predR$CAT)
facShapes<-c(16,17,15,18)
predR$annLabel<-paste(predR$posthocL, ' (',predR$k,')', sep='')

#ggplot
nfix.sp<-ggplot(data=predR,aes(x=pred,y=y, shape=CAT,label=annLabel)) + 
  geom_point(aes(shape=CAT),size=3) +
  geom_errorbarh(aes(xmin=cilb,xmax=ciub), height=0)+
  geom_vline(xintercept=0,linetype="dashed") + mytheme +
  xlab('Std. Mean Diff. (Inv-Ref)') + ylab('') +
  scale_y_continuous(breaks=seq(1,length(MeasFacl)),
                     labels=MeasNamesl) +
  scale_shape_manual(name="Factor",
                     labels=faclimits,
                     values=facShapes)+
  geom_text(aes(x=ciub, y=y, hjust=-0.3, vjust=0.5),size=2.2,show_guide = FALSE) +
  scale_x_continuous(expand=c(0,0), limits=c(-1.3,2.3))
nfix.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10))

newfilename<-"nfixForest.png"
png(paste(figuresPath,'modForests',newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
nfix.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10))
dev.off()
```
2Biii. Quality
```{r quality, echo=TRUE, warning=FALSE, message=FALSE}
currMeasFac<-anovaMods[anovaMods$anovaLabels=='qualityA' & anovaMods$pval < 0.05,'.id']
currMeasFac
#note - som doesn't have all levels of measQuality, so you need to have a different set of contrasts
#levels(dat.tmp$measQuality) #check to make sure that this lines up with the way I organized the contrasts
#Run post-hoc comparisions among Nfix levels, pull out means and CI
i<-0
posthoc.list<-list()
pred.list<-list()
for(i in 1:length(currMeasFac)){
  #1. calc posthoc pvals
  if(i %in% c(1,2)){
    posthocR<-anova(res.quality[[currMeasFac[i]]],
                    # A+C+, A+C-, A-C+, A-C-
                    L=rbind(c(1,-1,0,0), #A+C+ vs A+C-
                            c(1,0,-1,0), #A+C+ vs A-C+
                            c(1,0,0,-1), #A+C+ vs A-C-
                            c(0,1,-1,0), #A+C- vs A-C+
                            c(0,1,0,-1), #A+C- vs A-C-
                            c(0,0,1,-1)  #A-C+ vs A-C-
                    ))
    levelcomp<-c('both_a','both_c','both_none','a_c','a_none','c_none')
    posthoc.list[[i]]<-data.frame(levelcomp, pval=round(posthocR$pval, digits=4))
  }else{
    temp1<-subset(dat.tmp, measCat=='som')
    unique(temp1$measQuality)
    #levels: A+C-, A-C+, A-C-
    posthocR<-anova(res.quality[[currMeasFac[i]]], 
                    L=rbind(c(1,-1,0), #A+C- vs A-C+
                            c(1,0,-1), #A+C- vs A-C-
                            c(0,1,-1)  #A-C+ vs A-C-
                    ))
    levelcomp<-c('a_c','a_none','c_none')
    posthoc.list[[i]]<-data.frame(levelcomp, pval=round(posthocR$pval, digits=4))
  }
  
  #2. calc predicted values by level
  predR<-predict(res.quality[[currMeasFac[i]]])
  tmp<-data.frame(obsID=predR$slab, pred=predR$pred, cilb=predR$ci.lb, ciub=predR$ci.ub, se=predR$se)
  ind.Fac<-ddply(dat.tmp, ~obsID+measCat, summarize, Level=measQuality)
  ind.Fac.sub<-subset(ind.Fac, measCat==currMeasFac[i])
  tmp1<-merge(tmp, ind.Fac.sub)
  tmp2<-ddply(tmp1, ~Level, summarize,
        pred = unique(pred),
        cilb = unique(cilb),
        ciub = unique(ciub),
        se = unique(se),
        k = length(obsID))
  pred.list[[i]]<-tmp2
  
  }
names(posthoc.list)<-currMeasFac
posthocR<-ldply(posthoc.list)
posthocR

names(pred.list)<-currMeasFac
predR<-ldply(pred.list)
predR

#update effect size table for plotting
colnames(predR)[1]<-'MeasFac'
selectMeas<-unique(predR$MeasFac)
MeasFacl<-rev(levels(factor(MEASCAT[MEASCAT %in% selectMeas], levels=MEASCAT[MEASCAT %in% selectMeas])))
MeasNamesl<-rev(measTab[measTab$MEASCAT %in% selectMeas,'labels'])
colnames(predR)[2]<-'CAT'
CAT<-levels(dat$measQuality)
predR$y<-NA
i<-0
for(i in 1:length(MeasFacl)){
  predR[predR$CAT==CAT[1] & predR$MeasFac==MeasFacl[i],'y']<-i+0.3
  predR[predR$CAT==CAT[2] & predR$MeasFac==MeasFacl[i],'y']<-i+0.1
  predR[predR$CAT==CAT[3] & predR$MeasFac==MeasFacl[i],'y']<-i-0.1
  predR[predR$CAT==CAT[4] & predR$MeasFac==MeasFacl[i],'y']<-i-0.3
}
predR

#assign post-hoc letters (order ex:both, a, c, none)
#subset(posthocR, .id=='som')
phTnitrif<-c('','','','') #both vs c is marginally signif (p=0.059) 
phTnminz<-c('ab','ab','b','a') #both vs c is marginally signif (p=0.080), c vs none is signif (p=0.038)
phTsom<-c('ab','a','b') #c vs none pval=0.0128 
predR$posthocL<-c(phTnitrif,phTnminz, phTsom)

#assign pretty names and symbols
faclimits<-rev(c('No Manipulation','Units Converted',
                 'Values Aggregated','Units Converted &\nValues Aggregated'))
facShapes<-c(16,17,15,18)
predR$annLabel<-paste(predR$posthocL, ' (',predR$k,')', sep='')

#ggplot
qual.sp<-ggplot(data=predR,aes(x=pred,y=y, shape=CAT,label=annLabel)) + 
  geom_point(aes(shape=CAT),size=3) +
  geom_errorbarh(aes(xmin=cilb,xmax=ciub), height=0)+
  geom_vline(xintercept=0,linetype="dashed") + mytheme +
  xlab('Std. Mean Diff. (Inv-Ref)') + ylab('') +
  scale_shape_manual(name="Factor",
                     labels=faclimits,
                     values=facShapes) +
  scale_y_continuous(breaks=seq(1,length(MeasFacl)),
                     labels=MeasNamesl) +
  geom_text(aes(x=ciub, y=y, hjust=-0.3, vjust=0.5),size=2.2,show_guide = FALSE) +
  scale_x_continuous(expand=c(0,0),limits=c(-3,2.3))
qual.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10))

newfilename<-"qualityForest.png"
png(paste(figuresPath,'modForests',newfilename, sep='/'), units='in', width = fig.width*2, height = fig.height*2, res=fig.res)
qual.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10))
dev.off()
```
2Biv. Ecosystem type
```{r ecosyst, echo=TRUE, warning=FALSE, message=FALSE}
currMeasFac<-anovaMods[anovaMods$anovaLabels=='ecosystA' & anovaMods$pval < 0.05,'.id']
currMeasFac

#levels(dat.tmp$ecosystCat) #check to make sure that this lines up with the way I organized the contrasts
#Run post-hoc comparisions among Nfix levels, pull out means and CI
i<-0
posthoc.list<-list()
pred.list<-list()
for(i in 1:length(currMeasFac)){
  #1. calc posthoc pvals
  # forest, shrubland, grassland, wetland
  posthocR<-anova(res.ecosyst[[currMeasFac[i]]], 
      L=rbind(c(1,-1,0,0), #forest vs shrub
              c(1,0,-1,0), #forest vs grass
              c(1,0,0,-1), #forest vs wet
              c(0,1,-1,0), #shrub vs grass
              c(0,1,0,-1), #shrub vs wet
              c(0,0,1,-1) #grass vs wet
              ))
  levelcomp<-c('f_s','f_g','f_w',
                     's_g','s_w',
                           'g_w')
  posthoc.list[[i]]<-data.frame(levelcomp, pval=round(posthocR$pval, digits=4))
  #2. calc predicted values by level
  predR<-predict(res.ecosyst[[currMeasFac[i]]])
  tmp<-data.frame(obsID=predR$slab, pred=predR$pred, cilb=predR$ci.lb, ciub=predR$ci.ub, se=predR$se)
  ind.Fac<-ddply(dat.tmp, ~obsID, summarize, Level=unique(ecosystCat))
  tmp1<-merge(tmp, ind.Fac)
  tmp2<-ddply(tmp1, ~Level, summarize,
        pred = unique(pred),
        cilb = unique(cilb),
        ciub = unique(ciub),
        se = unique(se),
        k = length(obsID))
  pred.list[[i]]<-tmp2
  }
names(posthoc.list)<-currMeasFac
posthocR<-ldply(posthoc.list)
posthocR

names(pred.list)<-currMeasFac
predR<-ldply(pred.list)
predR

#update effect size table for plotting
colnames(predR)[1]<-'MeasFac'
selectMeas<-unique(predR$MeasFac)
MeasFacl<-rev(levels(factor(MEASCAT[MEASCAT %in% selectMeas], levels=MEASCAT[MEASCAT %in% selectMeas])))
MeasNamesl<-rev(measTab[measTab$MEASCAT %in% selectMeas,'labels'])
colnames(predR)[2]<-'CAT'
CAT<-levels(dat.tmp$ecosystCat)
predR$y<-NA
i<-0
for(i in 1:length(MeasFacl)){
  predR[predR$CAT==CAT[1] & predR$MeasFac==MeasFacl[i],'y']<-i+0.3
  predR[predR$CAT==CAT[2] & predR$MeasFac==MeasFacl[i],'y']<-i+0.1
  predR[predR$CAT==CAT[3] & predR$MeasFac==MeasFacl[i],'y']<-i-0.1
  predR[predR$CAT==CAT[4] & predR$MeasFac==MeasFacl[i],'y']<-i-0.3
}
predR

#assign post-hoc letters (order:f, s, g, w)
#subset(posthocR, .id=='soiln')
phTammonif<-c('a','b','b','b') 
phTsoiln<-c('b','bc','a','ac') #check this one
predR$posthocL<-c(phTammonif,phTsoiln)

#assign pretty names and symbols
faclimits<-rev(c('Wetland','Grassland','Shrubland','Forest'))
facShapes<-c(16,17,15,18)
predR$annLabel<-paste(predR$posthocL, ' (',predR$k,')', sep='')

#ggplot
eco.sp<-ggplot(data=predR,aes(x=pred,y=y, shape=CAT,label=annLabel)) + 
  geom_point(aes(shape=CAT),size=3) +
  geom_errorbarh(aes(xmin=cilb,xmax=ciub), height=0)+
  geom_vline(xintercept=0,linetype="dashed") + mytheme +
  xlab('Std. Mean Diff. (Inv-Ref)') + ylab('') +
  scale_y_continuous(breaks=seq(1,length(MeasFacl)),
                     labels=MeasNamesl) +
  scale_shape_manual(name="Factor",
                     labels=faclimits,
                     values=facShapes)+
  geom_text(aes(x=ciub, y=y, hjust=-0.3, vjust=0.5),size=2.2,show_guide = FALSE) +
  scale_x_continuous(expand=c(0,0), limits=c(-1.1,2))
eco.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10))

newfilename<-"ecosystForest.png"
png(paste(figuresPath,'modForests',newfilename, sep='/'), units='in', width = fig.width*1.5, height = fig.height*1.5, res=fig.res)
eco.sp + theme(axis.text.y=element_text(angle=90, hjust=0.5, size=10))
dev.off()
```

_________________________________________________________________
# 3. Test for correlation between CWM traits and effect size values
3A. Fit a random-effects model with 1 of the continuous trait variables as a fixed effect. Model syntax is res <- rma.mv(yi, vi, mods= ~Xmod, random=list(~1 | paperID, ~1 | obsID), data=dat1, subset=measCat==MEASCAT[i], slab=paste(paperID,obsID, sep=",")) where Xmod is one of the following 12 combinations:  
-> 1 of 3 plant communities: (1) InvSpInvArea_cwm, (2) NatArea_cwm, (3) CWMDiff_cwm  
-> 1 of 4 trait types: (1) percN, (2) litterpercN, (3) cn, (4) littercn  
where...
'InvSpInvArea_cwm' is the invasive species community weighted mean trait value;
'NatArea_cwm' is the reference area plant community weighted mean trait value;
'CWMDiff_cwm' is the dissimilarity between the Invaded - Reference area plant community weighted mean trait value;
'percN' is leaf %N;
'litterpercN' is litter %N;
'cn' is leaf C:N;
'littercn' is litter C:N;
```{r fitreg, echo=TRUE, warning=FALSE, message=FALSE}
INVlist<-FitPlot(dat, k=1)
NATlist<-FitPlot(dat, k=2)
DIFFlist<-FitPlot(dat, k=3)

INVtab<-rbind(ldply(INVlist[['results']][['percN']]),
              ldply(INVlist[['results']][['litterpercN']]),
              ldply(INVlist[['results']][['cn']]),
              ldply(INVlist[['results']][['littercn']]))[,-1]
NATtab<-rbind(ldply(NATlist[['results']][['percN']]),
              ldply(NATlist[['results']][['litterpercN']]),
              ldply(NATlist[['results']][['cn']]),
              ldply(NATlist[['results']][['littercn']]))[,-1]
DIFFtab<-rbind(ldply(DIFFlist[['results']][['percN']]),
              ldply(DIFFlist[['results']][['litterpercN']]),
              ldply(DIFFlist[['results']][['cn']]),
              ldply(DIFFlist[['results']][['littercn']]))[,-1]

newfilename<-'INVtab.txt'
write.table(INVtab, file=paste(figuresPath,'allRegressionTable',newfilename, sep='/'), sep='\t', row.names=FALSE)
newfilename<-'NATtab.txt'
write.table(NATtab, file=paste(figuresPath,'allRegressionTable',newfilename, sep='/'), sep='\t', row.names=FALSE)
newfilename<-'DIFFtab.txt'
write.table(DIFFtab, file=paste(figuresPath,'allRegressionTable',newfilename, sep='/'), sep='\t', row.names=FALSE)

INVtab[INVtab$pVal <0.1 & INVtab$measType %in% MEASCAT,]
NATtab[NATtab$pVal <0.1 & NATtab$measType %in% MEASCAT,]
DIFFtab[DIFFtab$pVal <0.1 & DIFFtab$measType %in% MEASCAT,]
```
3B. Plot some/all of the regressions
3Bi. CWM Diff Litter %N and Litter C:N VS nh, toti, nminz
```{r plotreg, echo=TRUE, warning=FALSE, message=FALSE}
#CWM Diff Litter %N and Litter C:N VS nh, toti, nminz

#set up panel margins
top<-0
right<-0.05
bottom<-0
left<-0.05

#set up labels
ylabel <- textGrob(c('Ammonium','Total inorg. N','Mineralization',
                  'Std. Mean Diff. (Inv-Ref)'), 
                y=c(0.83,0.5,0.15,
                    0.5),
                x=unit(c(2,2,2,
                         1),'lines'), rot=90)
xlabel<- textGrob(c('Invaded - Reference area\nLitter %N', 'Invaded - Reference area\nLitter C:N'), 
               x=c(0.25,0.75),
               y=unit(c(1,1), 'lines'))

#open image file connection
newfilename<-"exampleRegression.png"
png(paste(figuresPath,newfilename, sep='/'), units='in', width = fig.width*3, height = fig.height*4, res=fig.res)

#plot
grid.arrange(
  
  ylabel, # topleft
  
  arrangeGrob(
    
    DIFFlist[['figures']][['litterpercN']][['nh']] + ggtitle('a') + 
      theme(plot.margin = unit(c(top,right,bottom,left),"in")),
    DIFFlist[['figures']][['littercn']][['nh']] + ggtitle('d') +
      theme(plot.margin = unit(c(top,right,bottom,left),"in")),
    
    DIFFlist[['figures']][['litterpercN']][['toti']] + ggtitle('b') + 
      theme(plot.margin = unit(c(top,right,bottom,left),"in")),
    DIFFlist[['figures']][['littercn']][['toti']] + ggtitle('e') +
      theme(plot.margin = unit(c(top,right,bottom,left),"in")),
    
    DIFFlist[['figures']][['litterpercN']][['nminz']] + ggtitle('c')+
      theme(plot.margin = unit(c(top,right,bottom,left),"in")),
    DIFFlist[['figures']][['littercn']][['nminz']] + ggtitle('f') +
      theme(plot.margin = unit(c(top,right,bottom,left),"in")),
    
    nrow=3, ncol=2),
  
  textGrob(" "), #bottom left
  
  xlabel, #bottom right
  
  widths = unit.c(unit(2.5, "lines"), unit(1, "npc") - unit(2.5, "lines")), 
  heights = unit.c(unit(1, "npc") - unit(2.5, "lines"), unit(2.5, "lines")), 
  nrow=2, ncol=2)

dev.off()

```
3Bii. Loop through all plots: 1 page per trait type x community with 9 ES panels
```{r plotregAll, echo=TRUE, warning=FALSE, message=FALSE}
#add panel labels
INVlist1<-AddPanelTitles(INVlist)
NATlist1<-AddPanelTitles(NATlist)
DIFFlist1<-AddPanelTitles(DIFFlist)

#plot and save
PLANTlist<-list(INVlist1, NATlist1, DIFFlist1)
PLANTlabel<-c('INV','NAT','DIFF')
xlabel.PlantText<-c('Invasive species','Reference area','Invaded - Reference area')
xlabel.TraitText<-c('Leaf %N','Litter %N','Leaf C:N','Litter C:N')
l<-0
for(l in 1:length(PLANTlist)){
  i<-0
  for (i in 1:length(TRAIT)){
    CURRTRAIT<-PLANTlist[[l]][[i]]
    xlabel<- textGrob(paste(xlabel.PlantText[l],xlabel.TraitText[i], sep=", "), x=0.5, y=unit(1,'lines'))
    
    #open image file connection
    newfilename<-paste(paste(PLANTlabel[l],TRAIT[i], sep="_"),'.png',sep="")
    png(paste(figuresPath,'allRegressionPlots',newfilename, sep='/'), units='in', 
        width = fig.width*3.5, height = fig.height*3.5, res=fig.res)

    grid.arrange(
      textGrob('Std. Mean Diff. (Inv-Ref)', y=0.5,x=unit(1,'lines'), rot=90), # ylabel topleft
      do.call(arrangeGrob,  CURRTRAIT),
      textGrob(" "), #bottom left
      xlabel, #bottom right
      widths = unit.c(unit(2.5, "lines"), unit(1, "npc") - unit(2.5, "lines")), 
      heights = unit.c(unit(1, "npc") - unit(2.5, "lines"), unit(2.5, "lines")), 
      nrow=2, ncol=2
    )
    
    dev.off()
    
  }
}



```










