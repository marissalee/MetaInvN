---
title: "MIIN Part 4: summarize"
author: "Marissa Lee"
date: "June 1, 2015"
output: pdf_document
---

*Filename: MIIN_4_resultsOverview.Rmd*  
```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE)
```
_________________________________________________________________
## Load data and libraries  

1) Libraries and data that has already been processed by *MIIN_1_paperData.Rmd* and *MIIN_2_cwm.Rmd*
```{r load,echo=FALSE, warning=FALSE}
library(plyr)
library(doBy)
library(ggplot2)
library(reshape2)
library(gridExtra)
library(metafor)
source('rmdCode/mytheme.R')

#from clean
papers<-read.table("synthesizedData/clean/papers.txt", header=TRUE, sep="\t", quote="") # the quote part is needed to deal with the odd characters inside the doi and notes
observations<-read.table("synthesizedData/clean/observations.txt", header=TRUE, sep="\t") 
cover<-read.table("synthesizedData/clean/cover.txt", header=TRUE, sep="\t") 
species<-read.table("synthesizedData/clean/species.txt", header=TRUE, sep="\t") 
traits<-read.table("synthesizedData/clean/traits.txt", header=TRUE, sep="\t") 
measures<-read.table("synthesizedData/clean/measures.txt", header=TRUE, sep="\t")
cwm<-read.table("synthesizedData/clean/cwm.txt", header=TRUE, sep="\t")
spIDcover<-read.table("synthesizedData/clean/spIDcover.txt", header=TRUE, sep="\t")
spIDtraits<-read.table("synthesizedData/clean/spIDtraits.txt", header=TRUE, sep="\t")
forAnalysis<-read.table("synthesizedData/clean/forAnalysis.txt", header=TRUE, sep="\t")
```

2) Packages to cite
```{r cite,echo=FALSE, warning=FALSE}
citation()
if(nchar(system.file(package="plyr"))) citation("plyr")
if(nchar(system.file(package="ggplot2"))) citation("ggplot2")
if(nchar(system.file(package="metafor"))) citation("metafor")
```

_________________________________________________________________
# Summarize the article selction process: 

1) How many papers were detected with each search and how many were accepted/rejected? How many papers were detected by the top 3 sources and accepted/rejected through time?
```{r papers1,echo=FALSE, warning=FALSE, message=FALSE}
summ.papers <- ddply(papers,~source,summarise,
                     numPapers=length(read), 
                     numAcceptedPapers=sum(reject=='No'))
summ.papers<-orderBy(~-numPapers, summ.papers)
summ.papers2 <- ddply(papers,~source+rejectRationale,summarise,
                     numPapers=length(read), 
                     numAcceptedPapers=sum(reject=='No'))
summ.papers2<-orderBy(~-numPapers, summ.papers2)

totalNumReturned<-sum(summ.papers$numPapers)
numAlreadyFound<-sum(summ.papers2[summ.papers2$rejectRationale == 'alreadyFound' & !is.na(summ.papers2$rejectRationale),'numPapers'])
numUnique<-totalNumReturned - numAlreadyFound
paste(numUnique, 'unique papers identified by search criteria and their references')
paste(sum(summ.papers$numAcceptedPapers), 'papers were accepted')
paste(length(unique(forAnalysis$paperID)), 'papers were accepted, after removing papers with observations where there is not at least 1 species that is invasive, exotic, AND focal')

df<-subset(papers, source == 'Liao2007' | source == 'search1_111714' | source == 'search2_111714')
df2<-subset(df, reject == 'No' | reject == 'Yes')
df2$reject<-revalue(df2$reject, c("No"="Accepted papers", "Yes"="Rejected papers"))

pHist.papers<-ggplot(df2, aes(x=year, fill=source)) + mytheme + facet_wrap(~reject, scales="free_y", ncol=1) + 
  geom_histogram() +  scale_y_continuous(expand = c(0,0)) +
  ylab('Count') + xlab('Year')
filename<-"hist_papers.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 4, height = 4, res=300)
pHist.papers
dev.off()
```
![alt text](figures/hist_papers.png)  

2) With respect to papers referenced by Liao2007...  
a) How many accepted papers were published after the most recent Liao2007 reference?  
```{r papers2,echo=FALSE, warning=FALSE}
maxLiaoyr<-max(df2[df2$source == 'Liao2007','year'])
accepted.after<-subset(df2, source != 'Liao2007' & reject == 'Accepted papers' & year > maxLiaoyr)
paste(dim(accepted.after)[1], 'papers')
```
b) How many papers were rejected that Liao2007 referenced?  
```{r papers3,echo=FALSE, warning=FALSE}
rejected.Liao<-subset(df2, source == 'Liao2007' & reject == 'Rejected papers')
all.Liao<-subset(df2, source == 'Liao2007')
numLiaoRej<-dim(rejected.Liao)[1]
numLiaoAll<-dim(all.Liao)[1]
paste(dim(rejected.Liao)[1], 'papers, or', round((numLiaoRej/numLiaoAll) *100, digits=2), '% of Liao references' )
```
c) How many papers were accepted that were published before the most recent Liao2007 reference and were not included in the Liao2007 references.  
```{r papers4,echo=FALSE, warning=FALSE}
accepted.before<-subset(df2, source != 'Liao2007' & reject == 'Accepted papers' & year < maxLiaoyr)
numAccBef<-dim(accepted.before)[1]
paste(dim(accepted.before)[1], 'papers, or',round((numAccBef/numLiaoAll) *100, digits=2), '% of Liao references')
```




_________________________________________________________________
# Summarize the nature of the papers and observations in this dataset:

1) How many observations? What is the distribution of observations per paper?  
```{r obs1,echo=FALSE, warning=FALSE}
#paste(length(unique(observations$obsID)), 'observations')
paste(length(unique(forAnalysis$obsID)), 'observations')
summ.obs <- ddply(observations,~paperID,summarise, numObs=length(paperID))
median(summ.obs$numObs); range(summ.obs$numObs)
pHist.obs<-ggplot(summ.obs, aes(x=numObs)) + 
  scale_y_continuous(expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) +
  geom_histogram() + mytheme + 
  ylab('Count') + xlab('Number of observations per paper')
filename<-"hist_obsPerPaper.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 3, height = 3, res=300)
pHist.obs
dev.off()
```
![alt text](figures/hist_obsPerPaper.png)  

2) How are observations and papers distributed across ecosystem types and study types, legume presence?  
```{r obs2,echo=FALSE, warning=FALSE}
###ecosystem type
summ.obs.eco <- ddply(observations,~ecosystCat,summarise, numObs=length(paperID), numPapers=length(unique(paperID)))
summ.obs.eco.o<-orderBy(~-numObs, summ.obs.eco)
positions<-summ.obs.eco.o$ecosystCat
pBar.ecosyst<-ggplot(summ.obs.eco.o, aes(x=ecosystCat, y=numObs)) + 
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) + mytheme + 
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  geom_bar(stat='identity') + 
  ylab('Number of observations') + xlab('Ecosystem type')

###study type
summ.obs.st <- ddply(observations,~studyType,summarise, numObs=length(paperID))
summ.obs.st.o<-orderBy(~-numObs, summ.obs.st)
positions<-summ.obs.st.o$studyType
pBar.studyType<-ggplot(summ.obs.st.o, aes(x=studyType, y=numObs)) + 
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits= positions) + mytheme + 
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  geom_bar(stat='identity') + 
  ylab('Number of observations') + xlab('Study type')

###legumes present
summ.obs.leg <- ddply(observations,~InvLeg+NatLeg,summarise, numObs=length(paperID))
summ.obs.leg$Leg<-paste(summ.obs.leg$InvLeg, summ.obs.leg$NatLeg)
summ.obs.leg[,'Leg']<-c('I+, N-','I+, N+','I-,N-','I-,N+')
pBar.leg<-ggplot(summ.obs.leg, aes(x=Leg, y=numObs)) + 
  scale_y_continuous(expand=c(0,0)) + mytheme + theme(axis.text.x = element_text(angle=45, hjust=1)) +
  geom_bar(stat='identity') +  
  ylab('Number of observations') + xlab('Legume status of invasive (I) and reference (N) species')

#save a plot of all of them
filename<-"bar_obsPerType.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 7, res=300)
grid.arrange(pBar.ecosyst, pBar.studyType, pBar.leg)
dev.off()

#save a table with the number of observations per each factor

ecot<-data.frame(summ.obs.eco.o[,c(1,2)])
studt<-data.frame(summ.obs.st.o[,c(1,2)])
legt<-data.frame(summ.obs.leg[,c(4,3)])
factorlist<-list(ecot, studt, legt)
factortab<-ldply(factorlist)
factortab$factor<-c(rep('ecosystem',5), rep('studyType', 4), rep('legume',4))
factortab$level<-NA
factortab[!is.na(factortab$ecosystCat),'level']<-as.character(factortab[!is.na(factortab$ecosystCat),'ecosystCat'])
factortab[!is.na(factortab$studyType),'level']<-as.character(factortab[!is.na(factortab$studyType),'studyType'])
factortab[!is.na(factortab$Leg),'level']<-as.character(factortab[!is.na(factortab$Leg),'Leg'])
factortab1<-factortab[,c('factor','level','numObs')]

write.table(factortab1, file='tables/NumObs.txt', sep='\t')
```  
![alt text](figures/bar_obsPerType.png)   

3) What is the distribution of invasive species per observation?  Native species? Are certain invasive species over-represented?  
```{r obs3,echo=FALSE, warning=FALSE}
#number of inv/nat species per observation
summ.spp <- ddply(species,~obsID,summarise, 
                  numTotalspp=length(obsID), 
                  numInvspp=sum(spInvasive=='invasive' & spExotic=='exotic' & spFocal=='focal'), 
                  numNonInvspp=sum(spInvasive=='not invasive'),
                  numOthers=numTotalspp-(numInvspp + numNonInvspp))
hist_Inv<-ggplot(summ.spp, aes(x=numInvspp)) + geom_histogram() + 
  scale_y_continuous(expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) + 
  mytheme +  
  ylab('Count') + xlab('Number of invasive species per observation')
hist_Nat<-ggplot(summ.spp, aes(x=numNonInvspp)) + geom_histogram() + 
  scale_y_continuous(expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) +  
  mytheme +  
  ylab('Count') + xlab('Number of non-invasive species per observation')

#number of observations per species
summ.spp.nam <- ddply(species,~spName+spFocal+spExotic,summarise, 
                  numObs=length(obsID), 
                  numPapers=length(unique(paperID)))
spp.many<-summ.spp.nam[which(summ.spp.nam$numObs > 9 & summ.spp.nam$spFocal == 'focal'),] #more than 5 observations
spp.many.o<-orderBy(~-numObs, spp.many)
positions<-spp.many.o$spName
pBar<-ggplot(spp.many.o, aes(x=spName, y=numObs)) + geom_bar(stat='identity') + 
  scale_y_continuous(expand=c(0,0)) + scale_x_discrete(limits = positions) +
  mytheme +  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  ylab('Number of observations') + xlab('Invasive species')

#save plot of all of them
filename<-"hist_sppPerOb.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 7, res=300)
grid.arrange(hist_Inv, hist_Nat, pBar,
             heights=c(1,1,2))
dev.off()
```  
![alt text](figures/hist_sppPerOb.png)  

4) Which species appear both as exotic and native species in the dataset?  
```{r obs4,echo=FALSE, warning=FALSE}
summ.spp <- ddply(species,~spName+spExotic, summarise, 
                  numObs=length(obsID),
                  numPapers=length(unique(paperID)))
summ.spp.nam2 <- ddply(summ.spp,~spName,summarise, 
                  numInvNat=length(spExotic)) 
summ.spp.nam2[summ.spp.nam2$numInvNat==2,] # if the length of spInvasive col==2, then there is native and invasive listed
```

5) What percent of observations have measured cover data? 
```{r obs5,echo=FALSE, warning=FALSE}
summ.cov.obs <- ddply(cover,~obsID,summarise, 
                  numMeasured= sum(covQuality=='measured'))
numMeasured.obs<-sum(summ.cov.obs$numMeasured > 0)
numNot.obs<-length(summ.cov.obs$numMeasured > 0)
cov.obs.perc<-round((numMeasured.obs / (numMeasured.obs+numNot.obs) ) *100, digits=2)
paste(cov.obs.perc, '% of observations with cover data that was measured in the original paper',collapse='')

#What is the frequency of cover observations for each cover measure type? 
summ.cov <- ddply(cover,~covCat,summarise, 
                  numMeas = length(obsID),
                  numObs=length(unique(obsID)), 
                  numPapers=length(unique(paperID)))
#orderBy(~-numMeas, summ.cov)

#What units are commonly reported for each cover measure type?
summ.covUnit <- ddply(cover,~covCat+covUnit,summarise, 
                      numMeas = length(obsID),
                      numObs=length(unique(obsID)), 
                      numPapers=length(unique(paperID)))
COVCAT<-unique(summ.covUnit$covCat)
covUnitList<-list()
i<-0
for(i in 1:length(COVCAT)){
  subdf<-summ.covUnit[summ.covUnit$covCat==COVCAT[i],]
  covUnitList[[as.character(COVCAT[i])]]<-orderBy(~-numMeas, subdf)
}
#covUnitList

#Another way to look at this...
cwm.calc<-subset(cwm, qualityCWMcalc == 'calculated')
summ.cwm <- ddply(cwm.calc,~traitCat+invType,summarise,
                  numObs=length(unique(obsID)),
                  num1spAll_1=sum(qualityCover=='Measured=All, 1sp=All'),
                  num1spAll_2=sum(qualityCover=='Measured=None, 1sp=All'),
                  num1spAll_3=sum(qualityCover=='Measured=NA, 1sp=NA'),
                  num1spAll_4=sum(qualityCover=='Measured=Mid, 1sp=All'),
                  totalspAll=sum(num1spAll_1, num1spAll_2, num1spAll_3, num1spAll_4),
                  perc1spAll=(totalspAll/numObs) *100,
                  percEqual=100-perc1spAll)
summ.cwm2 <- ddply(summ.cwm,~invType,summarise,
                  mean1sp=mean(perc1spAll),
                  meanEqual=mean(percEqual),
                  seEqual=sd(percEqual)/sqrt(length(percEqual)))
summ.cwm2

summ.cwm3 <- ddply(cwm,~invType+traitCat+obsID,summarise,
                  numReported=sum(qualityCWMcalc=='reported'))
summ.cwm4 <- ddply(summ.cwm3,~traitCat+invType,summarise,
                  count=sum(numReported != 0),
                  total=length(obsID),
                  percRep=(count/total)*100)

```  

6) What percent of the the observations that have trait data? What is the frequency of observations for each measurement type and CWM trait type?   
```{r obs6,echo=FALSE, warning=FALSE}
###measures
summ.meas <- ddply(measures,~measCat,summarise, 
                   numMeas = length(obsID),
                   numObs=length(unique(obsID)))
summ.meas.o<-orderBy(~-numObs, summ.meas)
summ.meas.o
positions<-summ.meas.o$measCat
pBar.meas<-ggplot(summ.meas.o, aes(x=measCat, y=numObs)) + geom_bar(stat='identity') + 
  scale_y_continuous(expand=c(0,0)) + 
  mytheme +  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  scale_x_discrete(limits = positions,
                   labels = c('toti' = 'Total inorg. N',
                              'soiln' = 'Soil N',
                              'no' = 'Nitrate',
                              'nh' = 'Ammonium', 
                              'ph' = 'Soil pH',
                              'nminz' = 'Mineralization',
                              'soilcn' = 'Soil C:N',
                              'biom' = 'Plant biomass', 
                              'soilmoi' = 'Soil moisture', 
                              'som' = 'Soil organic\nmatter',
                              'nitrif' = 'Nitrification',
                              'ammonif' = 'Ammonification',
                              'percN' = 'CWM\nLeaf %N',
                              'litterbiom' = 'Litter biomass',
                              'litterpercN' = 'CWM\nLitter %N',
                              'littercn' = 'CWM\nLitter C:N',
                              'cn' = 'CWM\nLeaf C:N')) +
  ylab('Number of observations') + xlab('Measurement type')
#pBar.meas  

#What units and methods are commonly reported for each measurement?  
summ.measUnit <- ddply(measures,~measCat+unit,summarise, 
                   numMeas = length(obsID),
                   numObs=length(unique(obsID)))
MEASCAT<-unique(summ.measUnit$measCat)
measUnitList<-list()
i<-0
for(i in 1:length(MEASCAT)){
  subdf<-summ.measUnit[summ.measUnit$measCat==MEASCAT[i],]
  measUnitList[[as.character(MEASCAT[i])]]<-orderBy(~-numMeas, subdf)
}
#measUnitList

###traits
n.ot<-length(unique(traits$obsID)) # number of observations with trait data
n.o<-length(unique(observations$obsID)) # total number of observations
tr.obs.perc<-round((n.ot/n.o) *100, digits=2) # percent of observations with trait data
paste(tr.obs.perc, '% of observations with species-level trait data from either the original paper or trait database',collapse='')

summ.tr <- ddply(traits,~traitCat,summarise, 
                 numObs = length(unique(obsID)), 
                 numPapers = length(unique(paperID)))
summ.tr.o<-orderBy(~-numObs, summ.tr)
positions<-summ.tr.o$traitCat
pBar.tr<-ggplot(summ.tr.o, aes(x=traitCat, y=numObs)) + geom_bar(stat='identity') + 
  scale_y_continuous(expand=c(0,0)) + 
  scale_x_discrete(limits = positions, 
                   labels = c("sp_percN" = "Leaf %N",
                              "sp_cn" = "Leaf C:N", 
                              "sp_litterpercN" = "Litter %N",
                              "sp_littercn" = "Litter C:N")) +
  mytheme +  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  ylab('Number of observations') + xlab('Trait type (species-level)')

#What units and methods are commonly reported for each measurement? 
summ.traitUnit <- ddply(traits,~traitCat+traitUnit,summarise, 
                   numMeas = length(obsID),
                   numObs=length(unique(obsID)), 
                   numPapers=length(unique(paperID)))
#summ.traitUnit
TRAITCAT<-unique(summ.traitUnit$traitCat)
traitUnitList<-list()
i<-0
for(i in 1:length(TRAITCAT)){
  subdf<-summ.traitUnit[summ.traitUnit$traitCat==TRAITCAT[i],]
  traitUnitList[[as.character(TRAITCAT[i])]]<-orderBy(~-numMeas, subdf)
}
#traitUnitList

###plot
filename<-"bar_catPerOb.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 7, res=300)
grid.arrange(pBar.meas, pBar.tr)
dev.off()
```  
![alt text](figures/bar_catPerOb.png)  



_________________________________________________________________
# Summarize standardized soil measures
1) Normality  
```{r meas_qq,echo=FALSE, warning=FALSE}
#re-order measCat levels
forAnalysis$measCat <- factor(forAnalysis$measCat, levels = measCat_order)

#re-shape measures so that inv and nat are in the same column temporarily
tmp<-ddply(forAnalysis, ~obsID+measCat, summarize,
      m1i_logt = unique(m1i_logt),
      m2i_logt = unique(m2i_logt),
      measQuality = unique(measQuality))
tmp$obsID<-as.factor(tmp$obsID)
colnames(tmp)
m.tmp<-melt(tmp, idcols=c('obsID','measCat','measQuality'))
m.tmp$invType<-rep(NA,length(dim(m.tmp)[1])) 
m.tmp[m.tmp$variable == 'm1i_logt','invType']<-'inv'
m.tmp[m.tmp$variable == 'm2i_logt','invType']<-'ref'

#Shapiro Test
# ddply(measures, ~measCat, summarise, 
#       shapTest=shapiro.test(value)$p.value,
#       shapTest.Ln=shapiro.test(log(value+1))$p.value)
#none are normal according to Shapiro test

# Q-Q plots
qq<-ggplot(m.tmp, aes(sample=value)) + 
  facet_wrap(~measCat, scales='free', ncol=3) +
  stat_qq() + mytheme + ggtitle('QQ Plots of \nstd. measurement values')
filename<-"qq_meas.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 6, res=300)
facet_wrap_labeller(qq, labels = prettylabels.meas)
dev.off()
```  
![alt text](figures/qq_meas.png)  

2) Plot Quality Histograms
```{r figS3,echo=FALSE, warning=FALSE}
#re-order measQuality levels
m.tmp$measQuality <- factor(m.tmp$measQuality, levels = c('NoAgg.NoConv','NoAgg.Conv','Agg.NoConv','Agg.Conv'))

hist.meas<-ggplot(data=m.tmp, aes(x=value,fill=measQuality)) + mytheme +
  facet_wrap(~measCat, scales='free', ncol=3) + geom_histogram() +
  scale_y_continuous(expand = c(0,0)) + 
  scale_fill_manual(name = "Quality",
                    labels = c("Agg.Conv"="Aggregated & Converted", 
                               "Agg.NoConv"="Aggregated",
                               "NoAgg.Conv"="Converted",
                               "NoAgg.NoConv"="None"),
                    values=c("Agg.Conv" = "purple",
                             "Agg.NoConv" = "red",
                             "NoAgg.Conv" = "blue",
                             "NoAgg.NoConv" = "black")) +
  ylab('Count') + xlab('Standardized measurement value')
filename<-"figS3.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 6, res=300)
facet_wrap_labeller(hist.meas, labels = prettylabels.meas)
dev.off()
```  
![alt text](figures/figS3.png)  

_________________________________________________________________
# Summarize soil ESs
1) Normality  
```{r ESmeas_qq,echo=FALSE, warning=FALSE}

#re-shape measures so that inv and nat are in the same column temporarily
tmp<-ddply(forAnalysis, ~obsID+measCat, summarize,
      yi = unique(yi),
      measQuality = unique(measQuality))
tmp$obsID<-as.factor(tmp$obsID)

#Shapiro Test
# ddply(measures, ~measCat, summarise, 
#       shapTest=shapiro.test(value)$p.value,
#       shapTest.Ln=shapiro.test(log(value+1))$p.value)
#none are normal according to Shapiro test

# Q-Q plots
qq<-ggplot(tmp, aes(sample=yi)) + 
  facet_wrap(~measCat, scales='free', ncol=3) +
  stat_qq() + mytheme + ggtitle('QQ Plots of \nstd. measurement values')
filename<-"qq_meas.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 6, res=300)
facet_wrap_labeller(qq, labels = prettylabels.meas)
dev.off()
```  
![alt text](figures/qq_meas.png)  

2) Plot Quality Histograms
```{r ESmeas_hist,echo=FALSE, warning=FALSE}
#re-order measQuality levels
tmp$measQuality <- factor(tmp$measQuality, levels = c('NoAgg.NoConv','NoAgg.Conv','Agg.NoConv','Agg.Conv'))

hist.ESmeas<-ggplot(data=tmp, aes(x=yi,fill=measQuality)) + mytheme +
  facet_wrap(~measCat, scales='free', ncol=3) + geom_histogram() +
  scale_y_continuous(expand = c(0,0)) + 
  scale_fill_manual(name = "Quality",
                    labels = c("Agg.Conv"="Aggregated & Converted", 
                               "Agg.NoConv"="Aggregated",
                               "NoAgg.Conv"="Converted",
                               "NoAgg.NoConv"="None"),
                    values=c("Agg.Conv" = "purple",
                             "Agg.NoConv" = "red",
                             "NoAgg.Conv" = "blue",
                             "NoAgg.NoConv" = "black")) +
  ylab('Count') + xlab('Standardized measurement value')

filename<-"hist_ESmeas.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 5, height = 6, res=300)
facet_wrap_labeller(hist.ESmeas, labels = prettylabels.meas)
dev.off()
```  
![alt text](figures/figS3.png)  



_________________________________________________________________
# Summarize cwm trait values and invasive species trait values
1) Normality  
```{r cwm_qq,echo=FALSE, warning=FALSE}
#re-order measCat levels
forAnalysis$traitCat <- factor(forAnalysis$traitCat, levels = traitCat_order)
colnames(forAnalysis)
#re-shape measures so that inv and nat are in the same column temporarily
colnames(forAnalysis)
tmp<-ddply(forAnalysis, ~obsID+traitCat, summarize,
      InvArea_cwm = unique(InvArea_cwm),
      InvSpInvArea_cwm = unique(InvSpInvArea_cwm),
      NatArea_cwm = unique(NatArea_cwm),
      CWMDiff_cwm = unique(CWMDiff_cwm),
      InvArea_qualRank = unique(InvArea_qualRank),
      InvSpInvArea_qualRank = unique(InvSpInvArea_qualRank),
      NatArea_qualRank = unique(NatArea_qualRank),
      CWMDiff_qualRank = unique(InvArea_qualRank)+ unique(NatArea_qualRank))

tmp$obsID<-as.factor(tmp$obsID)
m.tmp<-melt(tmp, idcols=c('obsID','traitCat'))
m.tmp$dataType<-rep(NA,length(dim(m.tmp)[1])) #dataType
m.tmp[grepl('_qualRank', m.tmp$variable),'dataType']<-'qualRank'
m.tmp[grepl('_cwm', m.tmp$variable),'dataType']<-'cwm'
m.tmp$invType<-rep(NA,length(dim(m.tmp)[1])) #invType
m.tmp[grepl('InvArea', m.tmp$variable),'invType']<-'InvArea'
m.tmp[grepl('InvSpInvArea', m.tmp$variable),'invType']<-'InvSpInvArea'
m.tmp[grepl('NatArea', m.tmp$variable),'invType']<-'NatArea'
m.tmp[grepl('CWMDiff', m.tmp$variable),'invType']<-'CWMDiff'
c.tmp<-dcast(m.tmp, obsID+traitCat+invType~dataType)


# #Shapiro Test
# ddply(cwm, ~traitCat, summarise, 
#       shapTest=shapiro.test(cwm)$p.value,
#       shapTestLn=shapiro.test(log10(cwm))$p.value)
# #none are normal according to Shapiro test

# Q-Q plots
qq<-ggplot(c.tmp, aes(sample=cwm)) + 
  facet_wrap(~traitCat+invType, scales='free', ncol=4) + 
  stat_qq() + mytheme + ggtitle('QQ Plots of \n cwm trait values')

filename<-"qq_cwm.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 6, height = 4, res=300)
qq
dev.off()
```  
![alt text](figures/qq_cwm.png)  

2) Plot Factor Histograms
```{r cwm_hist,echo=FALSE, warning=FALSE}
#InvType
cwm$obsID<-as.factor(cwm$obsID)
cwm$n_invSp_invArea<-as.factor(cwm$n_invSp_invArea)
cwm$n_invSp_natArea<-as.factor(cwm$n_invSp_natArea)
cwm$n_natSp_invArea<-as.factor(cwm$n_natSp_invArea)
cwm$n_natSp_natArea<-as.factor(cwm$n_natSp_natArea)

#Legumes
cwm.tmp<-merge(cwm, observations, by='obsID')
cwm.tmp$Leg<-paste(cwm.tmp$InvLeg, cwm.tmp$NatLeg)
cwm.tmp <- transform(cwm.tmp, Leg = factor(Leg, levels=c("Non-legume Legumes absent",
                                                         "Non-legume Legumes present",
                                                         "Legume Legumes absent",
                                                         "Legume Legumes present")))
cwm.tmp <- transform(cwm.tmp, InvLeg = factor(InvLeg, levels=c("Legume", "Non-legume")))
cwm.tmp <- transform(cwm.tmp, NatLeg = factor(NatLeg, levels=c("Legumes present", "Legumes absent")))

#plot
p.cwm.ALL<-ggplot(data=cwm.tmp, aes(x=cwm,fill=invType)) + 
  facet_wrap(~Leg+traitCat, scales='free',ncol=4) + 
  scale_y_continuous(expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) +
  geom_histogram() + mytheme +
  ylab('Count') + xlab('CWM trait value') +
  scale_fill_manual(name="Plant community",
                    labels = c("Invaded Area", "Invasive spp","Reference Area"),
                    values = c("sienna4","green4","black"))
prettylabels.leg<-c("I- R-","I- R+","I+ R-","I+ R+")
prettylabels.trLeg<-paste(prettylabels.tr, ', Legumes:',rep(prettylabels.leg, each=length(prettylabels.tr)), sep='')
#facet_wrap_labeller(p.cwm.ALL, labels = prettylabels.trLeg)

#save plot
filename<-"hist_cwm.png"
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 9, height = 8, res=300)
facet_wrap_labeller(p.cwm.ALL, labels = prettylabels.trLeg)
dev.off()
```  
![alt text](figures/hist_cwm.png)  


3) Plot Quality Histograms
```{r figS1n2,echo=FALSE, warning=FALSE}
source('rmdCode/clean/script_qualityfreq.R') #work on this

#calculate the % coverage of trait data for each traitCat
summ.spIDtraits1<-ddply(spIDtraits1, ~traitCat, summarize,
                        nSp=length(spID),
                        nData=sum(!is.na(traitVal)),
                        perc_coverage=round((nData/nSp) *100, digits=2))
summ.spIDtraits1

#Figure S1 - Quality componenets of cwm values
filename<-"figS1.png" 
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 9, height = 8, res=300)
grid.arrange(facet_wrap_labeller(pS1a, labels = prettylabels.trAr),
             arrangeGrob(facet_wrap_labeller(pS1b, labels = c('Invaded Area','Reference Area')),
                         facet_wrap_labeller(pS1c, labels = prettylabels.tr),
                         ncol=2,
                         widths = c(2,3)),
             ncol=1)
dev.off()

#update str for quality rank
cwm$qualRank<-as.factor(cwm$qualRank)

#make plot
p.cwm.qual<-ggplot(data=cwm, aes(x=cwm,fill=qualRank)) + 
  facet_wrap(~invType+traitCat, scales='free',ncol=4) + 
  scale_y_continuous(expand=c(0,0)) + scale_x_continuous(expand=c(0,0)) +
  geom_histogram() + mytheme +
  ylab('Count') + xlab('CWM trait value') +
  scale_fill_manual(name='Quality rank',
                    labels=c("0","1","2","3","4"),
                    values=c("0" = "grey80",
                             "1" = "grey50",
                             "2" = "grey20",
                             "3" = "black",
                             "4" = "blue"))
prettylabels.Inv<-c("Invaded Area","Invasive spp","Reference Area")
prettylabels.trInv<-paste(prettylabels.tr, rep(prettylabels.Inv, each=length(prettylabels.tr)), sep=' ')
prettylabels.trInv
#facet_wrap_labeller(p.cwm.qual, labels = prettylabels.trInv)


#Figure S2 - Quality ranks of cwm values
filename<-"figS2.png" 
mypath<-file.path("/Users/mrl17/Documents/duke/wrightlab/projects/MetaInvN_Spring2011/MIIN_repository", "figures", filename)
png(mypath, units='in', width = 9, height = 8, res=300)
facet_wrap_labeller(p.cwm.qual, labels = prettylabels.trInv)
dev.off()
```  
![alt text](figures/figS1.png)  

![alt text](figures/figS2.png) 


